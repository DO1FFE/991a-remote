{% extends 'base.html' %}
{% block title %}FT-991A Steuerung{% endblock %}
{% block container_class %}radio-case ft991a{% endblock %}
{% block header_class %}rig-header{% endblock %}
{% block header_title %}FT-991A{% endblock %}
{% block nav %}<nav><a href="{{ url_for('logout') }}">Abmelden</a>{% if role == 'admin' %} | <a href="{{ url_for('admin_users') }}">Benutzerverwaltung</a>{% endif %}</nav>{% endblock %}
{% block content %}
    {% if role == 'admin' and unapproved_count %}
    <p class="warn">{{ unapproved_count }} Benutzer warten auf Freischaltung.</p>
    {% endif %}
    <p class="user-info">Angemeldet als {{ user }} ({{ role }})</p>
    <main>
        <div class="front-panel">
            <div class="screen">
                <div class="freq-display">14.074.000</div>
                <div class="s-meter"><div class="bar"></div></div>
                <div class="rtt-display">RTT: -- ms</div>
            </div>
            <div class="vfo">
                <div class="vfo-knob"></div>
            </div>
            <div class="buttons">
                <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                    <input type="hidden" name="cmd" value="mode">
                    <input type="hidden" name="value" value="0">
                    <button type="submit" class="mode-btn">MODE</button>
                </form>
                <form method="post" action="{{ url_for('command') }}" class="bandForm cmdForm">
                    <select name="value">
                        <option value="3500000">80m</option>
                        <option value="7000000">40m</option>
                        <option value="14000000" selected>20m</option>
                        <option value="21000000">15m</option>
                        <option value="28000000">10m</option>
                    </select>
                    <input type="hidden" name="cmd" value="frequency">
                    <button type="submit">BAND</button>
                </form>
            </div>
        </div>
        {% if not approved and role != 'admin' %}
        <p class="warn">Freischaltung ausstehend. Nur Empfang m&ouml;glich.</p>
        {% endif %}
        <div class="rig-select">
            <form method="post" action="{{ url_for('select_rig') }}" class="cmdForm">
                <label>Ger&auml;t:
                    <select name="rig" {% if not rigs %}disabled{% endif %}>
                    {% for r in rigs %}
                        <option value="{{ r }}" {% if r==selected_rig %}selected{% endif %}>{{ r }}</option>
                    {% endfor %}
                    </select>
                </label>
                <button type="submit" {% if not rigs %}disabled{% endif %}>Ausw&auml;hlen</button>
            </form>
            {% if not rigs %}
            <p>Hinweis: Kein TRX verbunden.</p>
            {% endif %}
            <p>Bediener:
                {% if operator %}
                    {{ operator }} ({{ operator_status or 'Unbekannt' }})
                {% else %}
                    keiner
                {% endif %}
            </p>
            {% if role == 'admin' or approved %}
                {% if operator == user %}
                <form method="post" action="{{ url_for('release_control') }}" class="cmdForm">
                    <button type="submit">Steuerung abgeben</button>
                </form>
                {% elif not operator %}
                <form method="post" action="{{ url_for('take_control') }}" class="cmdForm">
                    <button type="submit" {% if not rigs %}disabled{% endif %}>Steuerung &uuml;bernehmen</button>
                </form>
                {% else %}
                <form method="post" action="{{ url_for('take_control') }}" class="cmdForm">
                    <button type="submit" disabled>Steuerung &uuml;bernehmen</button>
                </form>
                {% endif %}
            {% endif %}
        </div>
        {% if (role == 'admin' or approved) %}
        {% set controls_disabled = (not rigs) or operator != user %}
        <div class="control-grid">
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <label>Frequenz (Hz): <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
                <input type="hidden" name="cmd" value="frequency">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Setzen</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <label>Modus-Nr.: <input type="text" name="value"></label>
                <input type="hidden" name="cmd" value="mode">
                <button type="submit">Modus</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <label>Shift:
                    <select name="value" {{ 'disabled' if controls_disabled else '' }}>
                        <option value="0">Simplex</option>
                        <option value="1">-</option>
                        <option value="2">+</option>
                    </select>
                </label>
                <input type="hidden" name="cmd" value="shift">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Shift</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <label>Offset (Hz): <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
                <input type="hidden" name="cmd" value="offset">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Offset</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <label>CTCSS (Hz): <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
                <input type="hidden" name="cmd" value="ctcss">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>CTCSS</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <label>DCS-Code: <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
                <input type="hidden" name="cmd" value="dcs">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>DCS</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <label>MIC Gain: <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
                <input type="hidden" name="cmd" value="mic_gain">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>MIC Gain</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <input type="hidden" name="cmd" value="ptt_on">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>PTT EIN</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <input type="hidden" name="cmd" value="ptt_off">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>PTT AUS</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <input type="hidden" name="cmd" value="get_frequency">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Frequenz lesen</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <input type="hidden" name="cmd" value="get_mode">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Modus lesen</button>
            </form>
            <form method="post" action="{{ url_for('command') }}" class="cmdForm">
                <label>CAT-Befehl: <input type="text" name="value" placeholder="EX;" {{ 'disabled' if controls_disabled else '' }}></label>
                <input type="hidden" name="cmd" value="cat">
                <button type="submit" {{ 'disabled' if controls_disabled else '' }}>CAT senden</button>
            </form>
        </div>
        {% endif %}
        <div class="audio-controls">
            <button onclick="startAudio()">Audio starten</button>
            <button onclick="stopAudio()">Audio stoppen</button>
        </div>
    </main>
{% endblock %}
{% block scripts %}
<script>
let sock;
let processor;
let audioRetry;
function startAudio(){
    function connect(){
        sock = new WebSocket('ws://' + location.host + '/ws/audio');
        sock.binaryType = 'arraybuffer';
        sock.onclose = () => {
            if(processor){ processor.disconnect(); processor=null; }
            audioRetry = setTimeout(connect, 1000);
        };
        navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({sampleRate:16000});
            const source = audioCtx.createMediaStreamSource(stream);
            processor = audioCtx.createScriptProcessor(1024,1,1);
            source.connect(processor);
            processor.connect(audioCtx.destination);
        processor.onaudioprocess = e=>{
            const input=e.inputBuffer.getChannelData(0);
            const buf=new ArrayBuffer(input.length*2);
            const view=new DataView(buf);
            for(let i=0;i<input.length;i++){
                let s=Math.max(-1,Math.min(1,input[i]));
                view.setInt16(i*2,s*0x7FFF,true);
            }
            if(sock.readyState===WebSocket.OPEN) sock.send(buf);
        };
        sock.onmessage=event=>{
            const view=new DataView(event.data);
            const floats=new Float32Array(view.byteLength/2);
            for(let i=0;i<floats.length;i++){
                floats[i]=view.getInt16(i*2,true)/0x8000;
            }
            const buffer=audioCtx.createBuffer(1,floats.length,16000);
            buffer.getChannelData(0).set(floats);
            const bs=audioCtx.createBufferSource();
            bs.buffer=buffer;
            bs.connect(audioCtx.destination);
            bs.start();
        };
        });
    }
    connect();
}
function stopAudio(){
    if(audioRetry){ clearTimeout(audioRetry); audioRetry=null; }
    if(processor){ processor.disconnect(); processor=null; }
    if(sock){ sock.close(); sock=null; }
}
let statusSock;
let statusRetry;
function formatFreq(f){
    const digits=f.replace(/[^0-9]/g,'');
    if(digits.length<=3) return digits;
    let out=digits.slice(-3);
    let rest=digits.slice(0,-3);
    if(rest.length>3){
        out=rest.slice(-3)+'.'+out;
        rest=rest.slice(0,-3);
    }
    if(rest) out=rest+'.'+out;
    return out;
}
function startStatus(){
    function connect(){
        statusSock=new WebSocket('ws://'+location.host+'/ws/status');
        statusSock.onclose=()=>{ statusRetry = setTimeout(connect, 1000); };
        statusSock.onerror=()=>{ if(statusSock.readyState!==WebSocket.CLOSED) statusSock.close(); };
        statusSock.onmessage=e=>{
            try{
                const data=JSON.parse(e.data);
                const v=data.values||{};
                if(v.FA){
                    document.querySelector('.freq-display').textContent=formatFreq(v.FA);
                }
                if(v.SM){
                    const m=v.SM.match(/\d+/);
                    if(m){
                        const pct=Math.min(100,Math.max(0,(parseInt(m[0])/255)*100));
                        document.querySelector('.s-meter .bar').style.width=pct+'%';
                    }
                }
                if(v.RTT!==undefined){
                    document.querySelector('.rtt-display').textContent = 'RTT: '+v.RTT+' ms';
                }
            }catch(err){}
        };
    }
    connect();
}
function stopStatus(){
    if(statusRetry){ clearTimeout(statusRetry); statusRetry=null; }
    if(statusSock){ statusSock.close(); statusSock=null; }
}
document.querySelectorAll('.cmdForm').forEach(f => {
    f.addEventListener('submit', e => {
        e.preventDefault();
        fetch(f.action, {method:'POST', body:new FormData(f)})
            .then(r => r.text())
            .then(t => { if(t) alert(t); });
    });
});
startStatus();
</script>
{% endblock %}
