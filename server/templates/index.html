<!DOCTYPE html>
<html>
<head>
    <title>FT-991A Steuerung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
<header>
    <h1>FT-991A Steuerung</h1>
    <nav><a href="{{ url_for('logout') }}">Abmelden</a>{% if role == 'admin' %} | <a href="{{ url_for('admin_users') }}">Benutzerverwaltung</a>{% endif %}</nav>
</header>
    <p>Angemeldet als {{ user }} ({{ role }})</p>
<main>
    <section class="controls-info">
        <h2>Wichtige Bedienelemente am FT-991A</h2>
        <ul>
            <li><strong>VFO-Drehregler</strong> zum Einstellen der Frequenz</li>
            <li><strong>Tastatur/Touchscreen</strong> zur direkten Eingabe</li>
            <li><strong>MODE-Taste</strong> f&uuml;r SSB, FM, AM usw.</li>
            <li><strong>PTT am Mikrofon</strong> f&uuml;r den Sendebetrieb</li>
            <li><strong>Men&uuml;optionen</strong> f&uuml;r Shift, Offset und CTCSS/DCS</li>
            <li><strong>MIC-Gain-Regler</strong> zur Pegelanpassung</li>
        </ul>
    </section>
    {% if not approved and role != 'admin' %}
    <p style="color:orange;">Freischaltung ausstehend. Nur Empfang m&ouml;glich.</p>
    {% endif %}
<form method="post" action="{{ url_for('select_rig') }}">
    <label>Ger&auml;t:
        <select name="rig" {% if not rigs %}disabled{% endif %}>
        {% for r in rigs %}
            <option value="{{ r }}" {% if r==selected_rig %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
        </select>
    </label>
    <button type="submit" {% if not rigs %}disabled{% endif %}>Ausw&auml;hlen</button>
</form>
{% if not rigs %}
<p>Hinweis: Kein TRX verbunden.</p>
{% endif %}
<p>Bediener:
    {% if operator %}
        {{ operator }} ({{ operator_status or 'Unbekannt' }})
    {% else %}
        keiner
    {% endif %}
</p>
{% if role == 'admin' or approved %}
    {% if operator == user %}
    <form method="post" action="{{ url_for('release_control') }}">
        <button type="submit">Steuerung abgeben</button>
    </form>
    {% elif not operator %}
    <form method="post" action="{{ url_for('take_control') }}">
        <button type="submit" {% if not rigs %}disabled{% endif %}>Steuerung &uuml;bernehmen</button>
    </form>
    {% else %}
    <form method="post" action="{{ url_for('take_control') }}">
        <button type="submit" disabled>Steuerung &uuml;bernehmen</button>
    </form>
    {% endif %}
{% endif %}
    {% if (role == 'admin' or approved) %}
    {% set controls_disabled = (not rigs) or operator != user %}
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <label>Frequenz (Hz): <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
        <input type="hidden" name="cmd" value="frequency">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Frequenz setzen</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <label>Modus-Nr.: <input type="text" name="value"></label>
        <input type="hidden" name="cmd" value="mode">
        <button type="submit">Modus setzen</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <label>Shift:
            <select name="value" {{ 'disabled' if controls_disabled else '' }}>
                <option value="0">Simplex</option>
                <option value="1">-</option>
                <option value="2">+</option>
            </select>
        </label>
        <input type="hidden" name="cmd" value="shift">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Shift setzen</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <label>Offset (Hz): <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
        <input type="hidden" name="cmd" value="offset">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Offset setzen</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <label>CTCSS (Hz): <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
        <input type="hidden" name="cmd" value="ctcss">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>CTCSS setzen</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <label>DCS-Code: <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
        <input type="hidden" name="cmd" value="dcs">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>DCS setzen</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <label>MIC Gain: <input type="text" name="value" {{ 'disabled' if controls_disabled else '' }}></label>
        <input type="hidden" name="cmd" value="mic_gain">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>MIC Gain setzen</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <input type="hidden" name="cmd" value="ptt_on">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>PTT EIN</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <input type="hidden" name="cmd" value="ptt_off">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>PTT AUS</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <input type="hidden" name="cmd" value="get_frequency">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Frequenz lesen</button>
    </form>
    <form method="post" action="{{ url_for('command') }}" class="cmdForm">
        <input type="hidden" name="cmd" value="get_mode">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>Modus lesen</button>
    </form>
    <form method="post" action="{{ url_for('command') }}">
        <label>CAT-Befehl: <input type="text" name="value" placeholder="EX;" {{ 'disabled' if controls_disabled else '' }}></label>
        <input type="hidden" name="cmd" value="cat">
        <button type="submit" {{ 'disabled' if controls_disabled else '' }}>CAT senden</button>
    </form>
    {% endif %}
    <button onclick="startAudio()">Audio starten</button>
    <button onclick="stopAudio()">Audio stoppen</button>
</main>
    <footer>&copy; {{ year }} by Erik Schauer, do1ffe@darc.de</footer>
</div>
<script>
let sock;
let processor;
function startAudio(){
    sock = new WebSocket('ws://' + location.host + '/ws/audio');
    sock.binaryType = 'arraybuffer';
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)({sampleRate:16000});
        const source = audioCtx.createMediaStreamSource(stream);
        processor = audioCtx.createScriptProcessor(1024,1,1);
        source.connect(processor);
        processor.connect(audioCtx.destination);
        processor.onaudioprocess = e=>{
            const input=e.inputBuffer.getChannelData(0);
            const buf=new ArrayBuffer(input.length*2);
            const view=new DataView(buf);
            for(let i=0;i<input.length;i++){
                let s=Math.max(-1,Math.min(1,input[i]));
                view.setInt16(i*2,s*0x7FFF,true);
            }
            if(sock.readyState===WebSocket.OPEN) sock.send(buf);
        };
        sock.onmessage=event=>{
            const view=new DataView(event.data);
            const floats=new Float32Array(view.byteLength/2);
            for(let i=0;i<floats.length;i++){
                floats[i]=view.getInt16(i*2,true)/0x8000;
            }
            const buffer=audioCtx.createBuffer(1,floats.length,16000);
            buffer.getChannelData(0).set(floats);
            const bs=audioCtx.createBufferSource();
            bs.buffer=buffer;
            bs.connect(audioCtx.destination);
            bs.start();
        };
    });
}
function stopAudio(){
    if(processor){ processor.disconnect(); processor=null; }
    if(sock){ sock.close(); sock=null; }
}
document.querySelectorAll('.cmdForm').forEach(f => {
    f.addEventListener('submit', e => {
        e.preventDefault();
        fetch(f.action, {method:'POST', body:new FormData(f)})
            .then(r => r.text())
            .then(t => { if(t) alert(t); });
    });
});
</script>
</body>
</html>
